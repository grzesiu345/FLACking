<!DOCTYPE html>
<head>
<meta charset="UTF-8" />
<title>FLACking</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: #fff;
    color: #000;
  }
  
  header {
    background: #222; color: white; padding: 10px 20px;
    display: flex; align-items: center; justify-content: space-between;
  }
  header h1 {
    margin: 0;
  }
  header input[type="search"] {
    width: 300px; padding: 6px 10px; font-size: 16px; border-radius: 4px; border: none;
    background: #fff;
    color: #000;
  }
  
  #settings-btn {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    margin-left: 10px;
  }
  #settings-panel {
    position: fixed;
    top: 60px;
    right: 20px;
    width: 250px;
    background: #333;
    color: white;
    border: 1px solid #555;
    border-radius: 8px;
    padding: 16px;
    display: none;
    flex-direction: column;
    z-index: 1000;
  }
  #settings-panel label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  #settings-panel input[type="checkbox"] {
    transform: scale(1.2);
  }

  #content {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  #albums {
    flex: 1;
    background: #fff;
    padding: 10px;
    overflow-y: auto;
    border-right: 1px solid #ccc;
  }

  .album-item {
    display: inline-block;
    width: 120px;
    margin: 8px;
    cursor: pointer;
    text-align: center;
  }
  .album-item img {
    width: 100px; height: 100px;
    object-fit: cover;
    border-radius: 4px;
    margin-bottom: 4px;
  }
  .album-item .title {
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .album-item .artist {
    color: #555;
    font-size: 14px;
  }

  #album-details {
    width: 450px;
    background: #f9f9f9;
    padding: 20px;
    display: flex;
    flex-direction: column;
  }
  #album-details.hidden {
    display: none;
  }
  #album-cover {
    width: 200px;
    height: 200px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 20px;
    align-self: center;
  }
  #album-info {
    text-align: center;
    margin-bottom: 20px;
  }
  #play-album-btn {
    padding: 10px 20px;
    background-color: #28a745;
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 16px;
    cursor: pointer;
    margin-bottom: 20px;
  }

  #track-list {
    flex: 1;
    overflow-y: auto;
  }
  #track-list table {
    width: 100%;
    border-collapse: collapse;
  }
  #track-list th, #track-list td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
    text-align: left;
  }
  #track-list tr:hover {
    background-color: #f1f1f1;
    cursor: pointer;
  }

  #player-bar {
    padding: 10px 20px;
    background: #eee;
    display: flex;
    align-items: center;
    border-top: 1px solid #ccc;
  }
  #now-playing {
    display: flex;
    align-items: center;
    width: 300px;
  }
  #now-playing img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    margin-right: 10px;
  }
  #controls {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #seek-bar {
    width: 100%;
    max-width: 500px;
    display: flex;
    align-items: center;
  }
  #seek {
    flex: 1;
  }
  #buttons {
    margin-top: 6px;
    display: flex;
    gap: 20px;
  }
  #buttons button {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  #volume-control {
    width: 120px;
    text-align: center;
  }
</style>
</head>
<body>

<header>
  <h1>FLACking</h1>
  <div>
    <input type="search" id="search" placeholder="Search...">
    <button id="settings-btn">⚙️</button>
  </div>
</header>

<div id="settings-panel">
  <label>
    Autoplay Next
    <input type="checkbox" id="toggle-autoplay" checked>
  </label>
</div>

<div id="content">
  <div id="albums"></div>
  <div id="album-details" class="hidden">
    <img id="album-cover" src="" alt="Okładka albumu" />
    <div id="album-info">
      <h2 id="album-title">Album title</h2>
      <p id="album-artist">Performer</p>
    </div>
    <button id="play-album-btn">▶️ Play Album</button>
    <div id="track-list">
      <table>
        <thead><tr><th>#</th><th>Title</th></tr></thead>
        <tbody id="track-list-body"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="player-bar">
  <div id="now-playing">
    <img src="" alt="cover" id="np-cover" />
    <div class="info">
      <div class="title" id="np-title">—</div>
      <div class="artist" id="np-artist">—</div>
    </div>
  </div>
  <div id="controls">
    <div id="seek-bar">
      <span id="current-time">00:00</span>
      <input type="range" id="seek" min="0" max="100" value="0" />
      <span id="duration">00:00</span>
    </div>
    <div id="buttons">
      <button id="prev">⏮️</button>
      <button id="play">▶️</button>
      <button id="next">⏭️</button>
    </div>
    <audio id="audio" preload="metadata"></audio>
  </div>
  <div id="volume-control">
    <label for="volume">Volume</label><br />
    <input type="range" id="volume" min="0" max="1" step="0.01" value="1" />
  </div>
</div>

<script>
  const API_BASE = '/api';
  let libraryData = {};
  let playQueue = [];
  let currentIndex = -1;

  const elems = {
    albums: document.getElementById('albums'),
    search: document.getElementById('search'),
    albumDetails: document.getElementById('album-details'),
    albumCover: document.getElementById('album-cover'),
    albumTitle: document.getElementById('album-title'),
    albumArtist: document.getElementById('album-artist'),
    playAlbumBtn: document.getElementById('play-album-btn'),
    trackListBody: document.getElementById('track-list-body'),

    npCover: document.getElementById('np-cover'),
    npTitle: document.getElementById('np-title'),
    npArtist: document.getElementById('np-artist'),
    audio: document.getElementById('audio'),
    currentTime: document.getElementById('current-time'),
    duration: document.getElementById('duration'),
    seek: document.getElementById('seek'),
    playBtn: document.getElementById('play'),
    prevBtn: document.getElementById('prev'),
    nextBtn: document.getElementById('next'),
    volume: document.getElementById('volume'),
  };

  fetch(API_BASE + '/library')
    .then(res => res.json())
    .then(data => {
      libraryData = data;
      renderAlbums();
    });

  function renderAlbums(filter = '') {
    elems.albums.innerHTML = '';
    for (const artist in libraryData) {
      for (const album in libraryData[artist]) {
        if (!album.toLowerCase().includes(filter) && !artist.toLowerCase().includes(filter)) continue;
        const item = document.createElement('div');
        item.className = 'album-item';
        const img = document.createElement('img');
        img.src = `${API_BASE}/cover/${encodeURIComponent(artist)}/${encodeURIComponent(album)}`;
        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = album;
        const art = document.createElement('div');
        art.className = 'artist';
        art.textContent = artist;
        item.append(img, title, art);
        item.onclick = () => showAlbumDetails(artist, album);
        elems.albums.appendChild(item);
      }
    }
  }

  function showAlbumDetails(artist, album) {
    elems.albumDetails.classList.remove('hidden');
    elems.albumCover.src = `${API_BASE}/cover/${encodeURIComponent(artist)}/${encodeURIComponent(album)}`;
    elems.albumTitle.textContent = album;
    elems.albumArtist.textContent = artist;
    const tracks = libraryData[artist][album].tracks;
    elems.trackListBody.innerHTML = '';
    tracks.forEach((file, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i + 1}</td><td>${file.replace(/^\d+\.\s*/, '').replace(/\.flac$/i, '')}</td>`;
      tr.onclick = () => {
        currentIndex = i;
        playQueue = tracks.map(f => ({ artist, album, file: f }));
        playCurrent();
      };
      elems.trackListBody.appendChild(tr);
    });
    playQueue = tracks.map(f => ({ artist, album, file: f }));
    currentIndex = 0;
  }

  function playCurrent() {
    if (currentIndex < 0 || currentIndex >= playQueue.length) return;
    const { artist, album, file } = playQueue[currentIndex];
    elems.audio.src = `${API_BASE}/music/${encodeURIComponent(artist)}/${encodeURIComponent(album)}/${encodeURIComponent(file)}`;
    elems.audio.play();
    updateNowPlaying(artist, album, file);
  }

  function updateNowPlaying(artist, album, file) {
    elems.npCover.src = `${API_BASE}/cover/${encodeURIComponent(artist)}/${encodeURIComponent(album)}`;
    elems.npTitle.textContent = file.replace(/^\d+\.\s*/, '').replace(/\.flac$/i, '');
    elems.npArtist.textContent = artist;
    elems.playBtn.textContent = '⏸️';
  }

  elems.playAlbumBtn.onclick = () => playCurrent();

  elems.playBtn.onclick = () => {
    if (elems.audio.paused) {
      elems.audio.play();
      elems.playBtn.textContent = '⏸️';
    } else {
      elems.audio.pause();
      elems.playBtn.textContent = '▶️';
    }
  };
  elems.prevBtn.onclick = () => {
    if (currentIndex > 0) {
      currentIndex--;
      playCurrent();
    }
  };
  elems.nextBtn.onclick = () => {
    if (currentIndex < playQueue.length - 1) {
      currentIndex++;
      playCurrent();
    }
  };

  elems.audio.ontimeupdate = () => {
    const ct = elems.audio.currentTime;
    const d = elems.audio.duration || 0;
    elems.currentTime.textContent = formatTime(ct);
    elems.duration.textContent = formatTime(d);
    elems.seek.value = d ? (ct / d) * 100 : 0;
  };

  elems.audio.onended = () => {
    const autoplay = localStorage.getItem('autoplay') !== 'false';
    if (autoplay && currentIndex < playQueue.length - 1) {
      currentIndex++;
      playCurrent();
    } else {
      elems.playBtn.textContent = '▶️';
    }
  };

  elems.seek.oninput = () => {
    const d = elems.audio.duration || 0;
    elems.audio.currentTime = (elems.seek.value / 100) * d;
  };

  elems.volume.oninput = () => {
    elems.audio.volume = elems.volume.value;
  };

  elems.search.oninput = e => {
    const q = e.target.value.trim().toLowerCase();
    renderAlbums(q);
    elems.albumDetails.classList.add('hidden');
  };

  function formatTime(sec) {
    const m = Math.floor(sec / 60).toString().padStart(2, '0');
    const s = Math.floor(sec % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  const settingsBtn = document.getElementById('settings-btn');
  const settingsPanel = document.getElementById('settings-panel');
  const toggleAutoplay = document.getElementById('toggle-autoplay');

  settingsBtn.onclick = () => {
    settingsPanel.style.display = settingsPanel.style.display === 'flex' ? 'none' : 'flex';
  };

  toggleAutoplay.onchange = () => {
    localStorage.setItem('autoplay', toggleAutoplay.checked);
  };

  window.onload = () => {
    const auto = localStorage.getItem('autoplay') !== 'false';
    toggleAutoplay.checked = auto;
  };
</script>

</body>
</html>
